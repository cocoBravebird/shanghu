<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>é»„å²›å•†æˆ· Â· å°±è¿‘ä¸é¡ºè·¯æ‹œè®¿ï¼ˆé«˜å¾·ä¸€ä½“åŒ–ï¼‰</title>
<style>
  html,body,#map{height:100%;margin:0;padding:0}
  .ui{position:absolute;top:10px;left:10px;z-index:9999;background:rgba(255,255,255,.97);
      border-radius:12px;padding:12px 14px;box-shadow:0 8px 24px rgba(0,0,0,.15);
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC','Microsoft YaHei',sans-serif;font-size:14px;line-height:1.6;max-width:640px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px}
  .btn{padding:6px 10px;border:1px solid #e5e5e5;border-radius:8px;background:#fff;cursor:pointer}
  .ip{height:32px;border:1px solid #e5e5e5;border-radius:8px;padding:0 10px}
  .small{font-size:12px;color:#666}
  .stat{margin-top:4px;color:#444}
  .ok{color:#2c7a7b}.warn{color:#b34700}.err{color:#c53030}
  .list{max-height:220px;overflow:auto;border:1px solid #eee;border-radius:8px;padding:6px;margin-top:6px}
  .item{padding:4px 0;border-bottom:1px dashed #eee}
  .item:last-child{border-bottom:none}
</style>

<!-- å¿…é¡»åœ¨ SDK ä¹‹å‰ï¼šä½ çš„ JS API å®‰å…¨å¯†é’¥ -->
<script>
  window._AMapSecurityConfig = { securityJsCode: "d9ca5519268c9fc0e9d8e1da9cc03a28" };
</script>
<!-- é«˜å¾· JS APIï¼ˆä½¿ç”¨ä½ çš„ Webç«¯ Keyï¼‰ï¼Œæ— éœ€é¢å¤–æ’ä»¶ï¼ˆæˆ‘ä»¬åªç”¨ Marker/InfoWindowï¼‰ -->
<script src="https://webapi.amap.com/maps?v=2.0&key=7d26448f257946798a105c1bc02d653b&plugin=AMap.Geocoder"></script>
</head>
<body>
<div id="map"></div>

<div class="ui">
  <div><b>âœ… é»„å²›å•†æˆ· Â· å°±è¿‘ä¸é¡ºè·¯æ‹œè®¿</b></div>
  <div id="health" class="small">åˆå§‹åŒ–ä¸­â€¦</div>

  <div class="row">
    <button class="btn" id="btnLocate">ğŸ“ è·å–å½“å‰ä½ç½®</button>
    <input class="ip" id="manualLng" placeholder="ç»åº¦(lng)" style="width:140px"/>
    <input class="ip" id="manualLat" placeholder="çº¬åº¦(lat)" style="width:140px"/>
    <button class="btn" id="btnUseManual">ç”¨æ‰‹åŠ¨åæ ‡</button>
  </div>

  <div class="row">
    <button class="btn" id="btnNearest">ğŸ” ç¦»æˆ‘æœ€è¿‘ï¼ˆå‰10ï¼‰</button>
    <button class="btn" id="btnRoute">ğŸ§­ ç”Ÿæˆé¡ºè·¯æ‹œè®¿é¡ºåº</button>
    <button class="btn" id="btnClearRoute">æ¸…é™¤è·¯çº¿</button>
  </div>

  <div class="row">
    <input class="ip" id="kw" placeholder="æœç´¢å§“å/ç«™å·/åœ°å€å…³é”®å­—" style="flex:1 1 260px"/>
    <button class="btn" id="btnSearch">æœç´¢</button>
    <button class="btn" id="btnShowAll">æ˜¾ç¤ºå…¨éƒ¨</button>
  </div>

  <div class="row">
    <button class="btn" id="btnExportKML">â¬‡ï¸ å¯¼å‡ºKML</button>
    <button class="btn" id="btnExportCSV">â¬‡ï¸ å¯¼å‡ºCSV</button>
    <span class="small">ï¼ˆå¯å¯¼å…¥æ”¯æŒæ‰¹é‡æ”¶è—çš„å¯¼èˆª/åœ°å›¾åº”ç”¨ï¼‰</span>
  </div>

  <div class="stat" id="stat">â€”</div>
  <div class="list" id="list"></div>
</div>

<script>
// ========== æ•°æ®ï¼šåœ°å€åˆ—è¡¨ï¼ˆä¼šåœ¨çº¿åœ°ç†ç¼–ç ä¸€æ¬¡ï¼Œç»“æœç¼“å­˜ localStorageï¼‰ ==========
const RAW = [
  {"ç«™å·":"3703006888","å§“å":"èµµä¿äº®","åœ°å€":"æ±Ÿå±±å—è·¯288å·æ–‡å®šæ±Ÿå±±314å·ä½“è‚²å½©ç¥¨","ç”µè¯":""},
  {"ç«™å·":"3703006180","å§“å":"ç‹æµ·æ´‹","åœ°å€":"å¤ªè¡Œå±±ä¸€è·¯æ”¯è·¯47å·","ç”µè¯":"17114447444"},
  {"ç«™å·":"3703005343","å§“å":"æè‰³æ´","åœ°å€":"ä¸œæ±Ÿè·¯æ€¡å’Œå®¶å›­åŒ—åŒº487å·","ç”µè¯":""},
  {"ç«™å·":"3703004225","å§“å":"é©¬æŒ¯ç¾¤","åœ°å€":"ç æ±Ÿè·¯é’å¹´å…¬å¯“106å·ä½“è‚²å½©ç¥¨","ç”µè¯":""},
  {"ç«™å·":"3703005906","å§“å":"è–›çº¢","åœ°å€":"é»„å²›åŒºæ´åº­å±±è·¯12å·","ç”µè¯":""},
  {"ç«™å·":"3703004348","å§“å":"è‘£è‰³","åœ°å€":"å¯Œæ˜¥æ±Ÿè·¯136å·ä½“è‚²å½©ç¥¨","ç”µè¯":""},
  {"ç«™å·":"3703003831","å§“å":"äºæµ·éœ","åœ°å€":"åºå±±è·¯77å·å®¶ä½³æºå—é—¨","ç”µè¯":""},
  {"ç«™å·":"3703003188","å§“å":"åˆ˜ç§‹éœ","åœ°å€":"è¾›å®‰è¡—é“å¼€æ‹“è·¯802å·","ç”µè¯":""},
  {"ç«™å·":"3703008034","å§“å":"é²é‡‘æµ·","åœ°å€":"é’±å¡˜æ±Ÿè·¯268å·-6å·ç½‘ç‚¹","ç”µè¯":""},
  {"ç«™å·":"3703003279","å§“å":"ç‰Ÿå–„äº®","åœ°å€":"é»„åŸ”æ±Ÿè·¯507å·ä½“è‚²å½©ç¥¨","ç”µè¯":""},
  {"ç«™å·":"3703003070","å§“å":"æ—æ²›æ²›","åœ°å€":"é•¿æ±Ÿè·¯è¡—é“é¦™æ±Ÿè·¯æµ·å°”æ‚¦å…°åº­äºŒæœŸ1067å·","ç”µè¯":""},
  {"ç«™å·":"3703005499","å§“å":"é™ˆçˆ±ä¸½","åœ°å€":"è¾›å®‰è¡—é“äº”é¾™æ²³è·¯772å·","ç”µè¯":""},
  {"ç«™å·":"3703006183","å§“å":"èµµå…¶ä¼Ÿ","åœ°å€":"èˆŸå±±å²›è¡—50å·ä½“è‚²å½©ç¥¨","ç”µè¯":""},
  {"ç«™å·":"3703003874","å§“å":"è¾›å‡¤å¨Ÿ","åœ°å€":"å¯Œæ˜¥æ±Ÿè·¯295å·ä½“è‚²å½©ç¥¨","ç”µè¯":""},
  {"ç«™å·":"3703006305","å§“å":"æé™","åœ°å€":"äº”å°å±±è·¯è´µä¿¡èŠ±å›­1114-8å·","ç”µè¯":""},
  {"ç«™å·":"3703004129","å§“å":"è–›å‹‡","åœ°å€":"æ±Ÿå±±ä¸½åŸæ¦•æ±Ÿè·¯12å·ç½‘ç‚¹","ç”µè¯":""},
  {"ç«™å·":"3703003773","å§“å":"ç‹æ˜æ˜","åœ°å€":"åé¡¶å±±è·¯æµ·å°”å±±æµ·æ¹¾è¥¿é—¨ä½“è‚²å½©ç¥¨","ç”µè¯":""},
  {"ç«™å·":"3703006556","å§“å":"å¼ å«ä½³","åœ°å€":"å›¢ç»“è·¯774å·","ç”µè¯":""},
  {"ç«™å·":"3703006550","å§“å":"èµµè¶…ç¾¤","åœ°å€":"å˜‰é™µæ±Ÿè¥¿è·¯693å·ç½‘ç‚¹","ç”µè¯":""},
  {"ç«™å·":"3703004208","å§“å":"å®‹äº‘æˆ˜","åœ°å€":"ä¸­å¾·ç”Ÿæ€å›­ç¦è±ç¤¾åŒºç¦è±å¤§è¡—26å·","ç”µè¯":""},
  {"ç«™å·":"3703007880","å§“å":"å’¸å¤","åœ°å€":"æ±‰æ±Ÿè·¯1å·å†…28-15B","ç”µè¯":""},
  {"ç«™å·":"3703003193","å§“å":"åˆ˜å¿ ç²","åœ°å€":"äº”å°å±±è·¯784å·","ç”µè¯":""},
  {"ç«™å·":"3703004170","å§“å":"é™ˆæ•¬é£","åœ°å€":"çº¢çŸ³å´–è¡—é“èŠ™è“‰è·¯18å·","ç”µè¯":""},
  {"ç«™å·":"3703007177","å§“å":"ç‹æ™¨","åœ°å€":"é•¿æ±Ÿè¥¿è·¯177å·é•¿æ±Ÿå›½é™…è´Ÿä¸€å±‚","ç”µè¯":""},
  {"ç«™å·":"3703004187","å§“å":"ç‹å†°","åœ°å€":"æ±Ÿå±±å—è·¯å¾¡å›­äº”å·216-11","ç”µè¯":""},
  {"ç«™å·":"3703005904","å§“å":"ç½—äº¬","åœ°å€":"é»„æ²³ä¸­è·¯146-3å·","ç”µè¯":""},
  {"ç«™å·":"3703006188","å§“å":"ä¾¯ç‰å¨Ÿ","åœ°å€":"é•¿æ±Ÿä¸­è·¯7å·13å·ç½‘ç‚¹","ç”µè¯":""},
  {"ç«™å·":"3703007632","å§“å":"å¼ æ–°æ™“","åœ°å€":"å›¢ç»“è·¯ä¸æ±¾æ²³è·¯äº¤å‰å£è·¯å—40ç±³","ç”µè¯":""},
  {"ç«™å·":"3703007605","å§“å":"æ›²æˆç«","åœ°å€":"ç´«é‡‘å±±è·¯27å·å°å¯éŸ³ä¹","ç”µè¯":""},
  {"ç«™å·":"3703004437","å§“å":"è–›æ–°æƒ ","åœ°å€":"ç‡•å±±è·¯278å·-4","ç”µè¯":""},
  {"ç«™å·":"3703003642","å§“å":"è–›ç§€èŠ³","åœ°å€":"é‡‘å±±è·¯127å·","ç”µè¯":""},
  {"ç«™å·":"3703008152","å§“å":"é‚¹æ´ªæ°¸","åœ°å€":"ç æ±Ÿè·¯106å·å‡¤å‡°åŸè¥¿é—¨31-14ç½‘ç‚¹","ç”µè¯":""},
  {"ç«™å·":"3703008037","å§“å":"èµµè‰³","åœ°å€":"é•¿ç™½å±±è·¯822-12å·å•†é“º","ç”µè¯":""},
  {"ç«™å·":"3703008156","å§“å":"æ±Ÿç¦æ˜¥","åœ°å€":"é‡‘æ²™æ»©è·¯966å·å‡¤å‡°ä¹‹å£°å¤§å‰§é™¢å¹¿åœºå‡¤å‡°å¤œå¸‚","ç”µè¯":""},
  {"ç«™å·":"3703003493","å§“å":"å•åŒå","åœ°å€":"é»„å²›è¡—é“å¤§ç¦å²›è·¯68å·","ç”µè¯":""},
  {"ç«™å·":"3703007314","å§“å":"ç‹è‰","åœ°å€":"é•¿æ±Ÿè·¯è¡—é“ä¸‡ç§‘æ–°éƒ½ä¼šäºŒæœŸå´æ±Ÿè·¯298å·","ç”µè¯":""},
  {"ç«™å·":"3703005491","å§“å":"æˆšéœ","åœ°å€":"é•¿æ±Ÿè·¯è¡—é“åŒ—æ±Ÿè·¯132-2å·","ç”µè¯":""},
  {"ç«™å·":"3703307058","å§“å":"å­™æ˜ç‡•","åœ°å€":"æ±Ÿå±±å—è·¯116å·é²å•†è“å²¸å›½é™…","ç”µè¯":"15563919457"}
];
const CITY_PREFIX = "é’å²›å¸‚é»„å²›åŒº";
const CACHE_KEY = "amap_huangdao_coords_v1";

// ========== åˆå§‹åŒ–åœ°å›¾ ==========
const map = new AMap.Map('map',{viewMode:'3D',zoom:12,center:[120.1695,35.9632]});
const info = new AMap.InfoWindow({offset:new AMap.Pixel(0,-10)});
const healthEl = document.getElementById('health');
let markers = [], currentPos = null, routeLine = null;

// ========== å·¥å…·å‡½æ•° ==========
const H = (lng1,lat1,lng2,lat2)=>{ // Haversine è·ç¦»ï¼ˆç±³ï¼‰
  const toRad=x=>x*Math.PI/180; const R=6371000;
  const dLat=toRad(lat2-lat1), dLng=toRad(lng2-lng1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
};
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const loadCache = ()=>{try{return JSON.parse(localStorage.getItem(CACHE_KEY)||'{}')}catch{return{}}};
const saveCache = o=>localStorage.setItem(CACHE_KEY,JSON.stringify(o||{}));
const keyFor = addr => (CITY_PREFIX + (addr||'').trim()).trim();

function renderList(arr, title='åˆ—è¡¨'){
  const stat = document.getElementById('stat');
  stat.innerHTML = `${title}ï¼šå…± <b>${arr.length}</b> ä¸ª${currentPos? 'ï¼ˆå·²æŒ‰è·ç¦»è®¡ç®—ï¼‰':''}`;
  const list = document.getElementById('list'); list.innerHTML = '';
  arr.forEach((r,i)=>{
    const div = document.createElement('div');
    const nav = r.lng&&r.lat ? `https://uri.amap.com/navigation?to=${r.lng},${r.lat},${encodeURIComponent(r.å§“å||r.ç«™å·||'ç›®æ ‡')}&mode=car` : '';
    div.className='item';
    div.innerHTML = `<b>${i+1}. ${r.å§“å||'æœªå'}</b> <span class="small">ï¼ˆ${r.ç«™å·||''}ï¼‰</span>
      <br/>åœ°å€ï¼š${r.åœ°å€||''} ${r.ç”µè¯?`Â· ğŸ“${r.ç”µè¯}`:''}
      ${r.dist!=null?`<br/><span class="small">è·ç¦»ï¼š${(r.dist/1000).toFixed(2)}km</span>`:''}
      ${nav?`<br/><a href="${nav}" target="_blank">ğŸš— å¯¼èˆª</a>`:''}`;
    list.appendChild(div);
  });
}

function makeMarker(r){
  const m = new AMap.Marker({position:[r.lng,r.lat],title:r.å§“å||r.ç«™å·||''});
  m.on('click',()=>{
    const nav = `https://uri.amap.com/navigation?to=${r.lng},${r.lat},${encodeURIComponent(r.å§“å||r.ç«™å·||'ç›®æ ‡')}&mode=car`;
    info.setContent(`<div style="font-size:14px;line-height:1.6;">
      <div><b>${r.å§“å||'æœªå'}</b> <span style="color:#999;">ï¼ˆç«™å·ï¼š${r.ç«™å·||''}ï¼‰</span></div>
      <div>åœ°å€ï¼š${r.åœ°å€||''}</div>
      <div>ç”µè¯ï¼š${r.ç”µè¯||'â€”'}</div>
      <div style="margin-top:6px;"><a href="${nav}" target="_blank" style="color:#1677ff;text-decoration:none;">ğŸš— ç”¨é«˜å¾·å¯¼èˆª</a></div>
    </div>`);
    info.open(map, m.getPosition());
  });
  map.add(m); markers.push(m);
}

function drawAllPoints(rows){
  markers.forEach(m=>map.remove(m)); markers=[];
  rows.filter(r=>r.lng&&r.lat).forEach(makeMarker);
  if (markers.length) map.setFitView(markers,true,[80,80,80,80],16);
}

// ========== åœ°ç†ç¼–ç ï¼ˆé¡ºåº + ç¼“å­˜ï¼‰==========
async function geocodeAll(){
  const cache = loadCache();
  const gc = new AMap.Geocoder({city:CITY_PREFIX});
  let done=0, total=RAW.length;
  healthEl.textContent = `å¼€å§‹åœ°ç†ç¼–ç ï¼ˆé¦–æ¬¡ä¼šç¨æ…¢ï¼Œè‡ªåŠ¨ç¼“å­˜ï¼‰â€¦`;
  for(const r of RAW){
    const addr=(r.åœ°å€||'').trim(); if(!addr){ done++; continue; }
    const k = keyFor(addr);
    if (!cache[k]){
      await new Promise(res=>{
        gc.getLocation(CITY_PREFIX+addr,(s,result)=>{
          if (s==='complete'&&result.geocodes&&result.geocodes.length){
            const loc=result.geocodes[0].location; cache[k]={lng:loc.lng,lat:loc.lat};
          } res();
        });
      });
      await sleep(100);
    }
    done++;
  }
  saveCache(cache);
  healthEl.innerHTML = `ç¼–ç å®Œæˆï¼Œå·²ç¼“å­˜ <b>${Object.keys(cache).length}</b> æ¡ï¼›ä¸‹æ¬¡æ‰“å¼€å°†ç§’å¼€ã€‚`;
  // ç»„è£…è¡Œ
  const rows = RAW.map(r=>{
    const c = loadCache()[keyFor(r.åœ°å€)];
    return {...r, lng:c&&c.lng, lat:c&&c.lat};
  });
  drawAllPoints(rows);
  renderList(rows,'å…¨éƒ¨ç«™ç‚¹');
  return rows;
}

// ========== å½“å‰ä½ç½® ==========
async function getCurrentPosition(){
  return new Promise(resolve=>{
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos=>resolve([pos.coords.longitude,pos.coords.latitude]),
        _=>resolve(null),
        {enableHighAccuracy:true,timeout:8000}
      );
    } else resolve(null);
  });
}

// ========== è¿‘é‚»è§„åˆ’ï¼ˆè´ªå¿ƒæ³•ï¼‰ ==========
function planGreedy(start, points){ // start: {lng,lat}
  const remain = points.slice();
  const order = []; let cur = {lng:start.lng, lat:start.lat};
  while(remain.length){
    remain.forEach(p=>p._d = H(cur.lng,cur.lat,p.lng,p.lat));
    remain.sort((a,b)=>a._d - b._d);
    const nxt = remain.shift();
    order.push(nxt);
    cur = {lng:nxt.lng, lat:nxt.lat};
  }
  order.forEach(p=>delete p._d);
  return order;
}

function drawRoute(order, start){
  if (routeLine) { map.remove(routeLine); routeLine=null; }
  const path = [ [start.lng,start.lat], ...order.map(p=>[p.lng,p.lat]) ];
  routeLine = new AMap.Polyline({path, strokeWeight:6, strokeColor:'#1677ff', strokeOpacity:0.8});
  map.add(routeLine);
  const allMarkers = markers.slice();
  map.setFitView([routeLine, ...allMarkers], true, [60,60,60,360], 16);
}

// ========== å¯¼å‡º ==========
function download(name,content,type){ const blob=new Blob([content],{type}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }
function exportCSV(rows){
  const header = 'ç«™å·,å§“å,åœ°å€,ç”µè¯,ç»åº¦,çº¬åº¦\n';
  const body = rows.map(r=>[r.ç«™å·||'',r.å§“å||'',r.åœ°å€||'',r.ç”µè¯||'',r.lng||'',r.lat||''].map(v=>`"${(v+'').replace(/"/g,'""')}"`).join(',')).join('\n');
  download('é»„å²›å•†æˆ·.csv', header+body, 'text/csv;charset=utf-8');
}
function exportKML(rows){
  const placemarks = rows.filter(r=>r.lng&&r.lat).map(r=>
  `<Placemark>
    <name>${(r.å§“å||r.ç«™å·||'æ ‡æ³¨').replace(/[<&>]/g,'')}</name>
    <description><![CDATA[ç«™å·ï¼š${r.ç«™å·||''}<br/>åœ°å€ï¼š${r.åœ°å€||''}<br/>ç”µè¯ï¼š${r.ç”µè¯||'â€”'}]]></description>
    <Point><coordinates>${r.lng},${r.lat},0</coordinates></Point>
  </Placemark>`).join('\n');
  const kml = `<?xml version="1.0" encoding="UTF-8"?>
  <kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>é»„å²›å•†æˆ·</name>${placemarks}</Document></kml>`;
  download('é»„å²›å•†æˆ·.kml', kml, 'application/vnd.google-earth.kml+xml');
}

// ========== äº‹ä»¶ ==========
let ALL_ROWS = [];
(async function init(){
  healthEl.textContent = 'åˆå§‹åŒ–åœ°å›¾å®Œæˆï¼Œå‡†å¤‡ç¼–ç â€¦';
  ALL_ROWS = await geocodeAll();
})();

document.getElementById('btnLocate').onclick = async ()=>{
  const p = await getCurrentPosition();
  if (!p) { healthEl.className='warn'; healthEl.textContent='æ— æ³•è·å–ç³»ç»Ÿå®šä½ï¼ˆå»ºè®®ç”¨ HTTPS æˆ–å…è®¸å®šä½ï¼‰ï¼Œå¯æ‰‹åŠ¨è¾“å…¥åæ ‡'; return; }
  currentPos = {lng:p[0],lat:p[1]};
  healthEl.className='ok'; healthEl.textContent=`å·²è·å–å½“å‰ä½ç½®ï¼š${p[0].toFixed(6)}, ${p[1].toFixed(6)}`;
  new AMap.Marker({position:p, map, title:'æˆ‘çš„ä½ç½®', icon:'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png'});
  map.setZoomAndCenter(13, p);
};

document.getElementById('btnUseManual').onclick = ()=>{
  const lng = parseFloat(document.getElementById('manualLng').value);
  const lat = parseFloat(document.getElementById('manualLat').value);
  if (isFinite(lng) && isFinite(lat)) {
    currentPos = {lng,lat};
    healthEl.className='ok'; healthEl.textContent=`å·²ä½¿ç”¨æ‰‹åŠ¨åæ ‡ï¼š${lng}, ${lat}`;
    new AMap.Marker({position:[lng,lat], map, title:'æˆ‘çš„ä½ç½®', icon:'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png'});
    map.setZoomAndCenter(13, [lng,lat]);
  } else {
    healthEl.className='warn'; healthEl.textContent='è¯·è¾“å…¥æ­£ç¡®çš„ç»çº¬åº¦ï¼ˆå¦‚ 120.1695 / 35.9632ï¼‰';
  }
};

document.getElementById('btnNearest').onclick = ()=>{
  if (!currentPos) { healthEl.className='warn'; healthEl.textContent='è¯·å…ˆè·å–å½“å‰ä½ç½®æˆ–æ‰‹åŠ¨è¾“å…¥åæ ‡'; return; }
  const rows = ALL_ROWS.filter(r=>r.lng&&r.lat).map(r=>({...r, dist:H(currentPos.lng,currentPos.lat,r.lng,r.lat)}));
  rows.sort((a,b)=>a.dist-b.dist);
  renderList(rows.slice(0,10), 'ç¦»æˆ‘æœ€è¿‘ï¼ˆå‰10ï¼‰');
};

document.getElementById('btnRoute').onclick = ()=>{
  if (!currentPos) { healthEl.className='warn'; healthEl.textContent='è¯·å…ˆè·å–å½“å‰ä½ç½®æˆ–æ‰‹åŠ¨è¾“å…¥åæ ‡'; return; }
  const points = ALL_ROWS.filter(r=>r.lng&&r.lat);
  const order = planGreedy(currentPos, points);
  // å±•ç¤ºåˆ—è¡¨ï¼ˆé™„å¯¼èˆªé“¾æ¥ï¼‰
  const withDist = order.map(r=>({...r, dist:H(currentPos.lng,currentPos.lat,r.lng,r.lat)}));
  renderList(withDist, 'é¡ºè·¯æ‹œè®¿é¡ºåºï¼ˆè¿‘é‚»æ³•ï¼‰');
  drawRoute(order, currentPos);
};

document.getElementById('btnClearRoute').onclick = ()=>{
  if (routeLine) { map.remove(routeLine); routeLine=null; }
  renderList(ALL_ROWS,'å…¨éƒ¨ç«™ç‚¹'); drawAllPoints(ALL_ROWS);
};

document.getElementById('btnSearch').onclick = ()=>{
  const kw = (document.getElementById('kw').value||'').trim();
  const rows = ALL_ROWS.filter(r=>(r.å§“å||'').includes(kw)||(r.ç«™å·||'').includes(kw)||(r.åœ°å€||'').includes(kw));
  drawAllPoints(rows); renderList(rows, `æœç´¢ã€Œ${kw}ã€ç»“æœ`);
};

document.getElementById('btnShowAll').onclick = ()=>{ drawAllPoints(ALL_ROWS); renderList(ALL_ROWS,'å…¨éƒ¨ç«™ç‚¹'); };

document.getElementById('btnExportKML').onclick = ()=>exportKML(ALL_ROWS);
document.getElementById('btnExportCSV').onclick = ()=>exportCSV(ALL_ROWS);
</script>
</body>
</html>
