<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å•†æˆ·åŒå›¾å±‚ Â· åœ¨çº¿é¢„è®¡ç®—å™¨ï¼ˆGitHub Pagesï¼‰</title>
<style>
  html,body,#map{height:100%;margin:0}
  .panel{position:absolute;top:10px;left:10px;z-index:9;background:#fff;border-radius:12px;padding:12px 14px;box-shadow:0 8px 24px rgba(0,0,0,.15);font:14px/1.6 -apple-system,BlinkMacSystemFont,'PingFang SC','Microsoft YaHei',sans-serif;max-width:760px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px}
  .btn{padding:6px 10px;border:1px solid #e5e5e5;border-radius:8px;background:#fff;cursor:pointer}
  .bar{width:440px;height:8px;background:#f1f1f1;border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;width:0;background:#1677ff;transition:width .2s}
  .log{position:absolute;left:10px;bottom:10px;z-index:9;background:rgba(0,0,0,.65);color:#fff;padding:8px 10px;border-radius:8px;max-width:560px;max-height:36vh;overflow:auto;font:12px/1.6 ui-monospace,Consolas,monospace}
</style>

<!-- é«˜å¾·å®‰å…¨å¯†é’¥ï¼šå¿…é¡»åœ¨ SDK ä¹‹å‰ -->
<script>
  window._AMapSecurityConfig = { securityJsCode: "d9ca5519268c9fc0e9d8e1da9cc03a28" };
</script>
<!-- JS API + Geocoder æ’ä»¶ï¼ˆç”¨ä½ çš„ Keyï¼‰ -->
<script src="https://webapi.amap.com/maps?v=2.0&key=7d26448f257946798a105c1bc02d653b&plugin=AMap.Geocoder"></script>
</head>
<body>
<div id="map"></div>
<div class="panel">
  <b>å•†æˆ·åŒå›¾å±‚ Â· åœ¨çº¿é¢„è®¡ç®—å™¨</b>
  <div class="row">
    <button id="run" class="btn">å¼€å§‹/é‡è·‘</button>
    <button id="dump" class="btn">å¯¼å‡ºåæ ‡ JSON</button>
  </div>
  <div class="bar"><i id="p"></i></div>
  <div id="msg">å°±ç»ªã€‚è‹¥æŠ¥ Key/ç™½åå•ï¼Œè¯·æŠŠ <code>*.github.io</code> / <code>cocobravebird.github.io</code> åŠ å…¥é«˜å¾· Key çš„ Referer ç™½åå•ã€‚</div>
</div>
<div id="log" class="log"></div>

<script>
const CITY="é’å²›å¸‚"; const CENTER=[120.3552,36.0826];

// â€”â€” å…¨é‡å›¾å±‚ï¼ˆä¸Šä¸€ç‰ˆâ€œæ–°æ¸…å•â€ï¼‰ â€”â€”
const RAW_ALL = [
  {name:"å•†æˆ·_é—«æ¶µ", addr:"å…´éš†è·¯10å·", phone:"13325009494", mch:"105000479953210", subwx:"å¾®ä¿¡814221549", subali:"æ”¯ä»˜å®2088970723467122"},
  {name:"å•†æˆ·_å§œçˆ±å›", addr:"ææ²§åŒºå»¶å·è·¯1å·A-11å·ç½‘ç‚¹", phone:"", mch:"105000479953213", subwx:"å¾®ä¿¡814442663", subali:"æ”¯ä»˜å®2088970739600832"},
  {name:"å•†æˆ·_å¼ äºšä¸½", addr:"å¨æµ·è·¯262å·ç¾å®å•†åŠ¡æ¥¼", phone:"15315996321", mch:"105000479953217", subwx:"å¾®ä¿¡814443314", subali:"æ”¯ä»˜å®2088970740907515"},
  {name:"å•†æˆ·_å´”å®", addr:"å°ä¸œä¸ƒè·¯ä¸é¡ºå…´è·¯äº¤å‰å£", phone:"", mch:"105000479953219", subwx:"å¾®ä¿¡814442789", subali:"æ”¯ä»˜å®2088970741303022"},
  {name:"å•†æˆ·_èŒƒå©·å©·", addr:"å»¶å‰è·¯77å·1-2ç½‘ç‚¹", phone:"13061398069", mch:"105000479953227", subwx:"å¾®ä¿¡814557557", subali:"æ”¯ä»˜å®2088970750039545"},
  {name:"å•†æˆ·_ç‹çç", addr:"å…´å¾·è·¯96å·-2", phone:"15854239667", mch:"105000479953255", subwx:"å¾®ä¿¡816708110", subali:"æ”¯ä»˜å®2088080024554435"},
  {name:"å•†æˆ·_ç”°æƒ ", addr:"å¤§æ¸¯ä¸€è·¯59å·", phone:"13505428583", mch:"105000479953258", subwx:"å¾®ä¿¡816708033", subali:"æ”¯ä»˜å®2088080024949615"},
  {name:"å•†æˆ·_è–›å©§", addr:"è¾½é˜³è¥¿è·¯2å·", phone:"13969729607", mch:"105000479953273", subwx:"å¾®ä¿¡817038027", subali:"æ”¯ä»˜å®2088080048186119"},
  {name:"ææ²§åŒºæ‚¦å¨æºé¤é¥®åº—(ä¸ªä½“å·¥å•†æˆ·)", addr:"é»‘é¾™æ±Ÿä¸­è·¯649å·E01", phone:"15712706395", mch:"105012158129339", subwx:"å¾®ä¿¡817049675", subali:"æ”¯ä»˜å®2088080047581948"},
  {name:"å¸‚åŒ—åŒºçˆ±è¯ºæ³½æ˜Ÿæ•°ç ç§‘æŠ€æœåŠ¡ä¸­å¿ƒ(ä¸ªä½“å·¥å•†æˆ·)", addr:"è¾½å®è·¯147å·ç™¾è„‘æ±‡0H18", phone:"18605329800", mch:"105000150453987", subwx:"å¾®ä¿¡817130325", subali:"æ”¯ä»˜å®2088080052675650"},
  {name:"å•†æˆ·_åˆ˜ç„•æ–Œ", addr:"ä¸‡å¹´æ³‰è·¯116å·", phone:"18953220501", mch:"105000479953281", subwx:"å¾®ä¿¡817130729", subali:"æ”¯ä»˜å®105000479953281"},
  {name:"å•†æˆ·_ç‹çŸ¥æ–‡", addr:"äººæ°‘è·¯130å·", phone:"18661920863", mch:"105000479953282", subwx:"å¾®ä¿¡817130641", subali:"æ”¯ä»˜å®2088080055589248"},
  {name:"å•†æˆ·_ç”˜å»¶çœŸ", addr:"å¤åº„è·¯1å·ä¹å®¢åŸB1-D-08-15å·", phone:"17191090195", mch:"105000479953301", subwx:"å¾®ä¿¡817346325", subali:"æ”¯ä»˜å®2088080067181782"},
  {name:"å•†æˆ·_ç‰›åº†æ–‹", addr:"å¤åº„è·¯1å·ä¼Ÿä¸œä¹å®¢åŸè´Ÿä¸€æ‚¦è¡—A-29-1", phone:"13615423696", mch:"105000479953345", subwx:"å¾®ä¿¡818391433", subali:"æ”¯ä»˜å®2088080148535343"},
  {name:"é’å²›å¸‚ææ²§åŒºå±¿å²¸çº¿äº’è”ç½‘ç§‘æŠ€å·¥ä½œå®¤", addr:"ææ²§åŒºå®¾å·è·¯51-38å·", phone:"18105324252", mch:"105000373724202", subwx:"å¾®ä¿¡818634197", subali:"æ”¯ä»˜å®2088080166243842"},
  {name:"å¸‚åŒ—åŒºæ­¦å“¥ç™¾è´§åº—", addr:"å°ä¸œä¸ƒè·¯ä¸é¡ºå…´è·¯äº¤å‰å£", phone:"", mch:"105006753316545", subwx:"å¾®ä¿¡818637066", subali:"æ”¯ä»˜å®2088080166669020"},
  {name:"é»„å²›åŒºä¼˜å®æ¥ç©å…·é”€å”®åº—", addr:"èƒ¶å— è¾¹å“¥å®¢æˆ· å…·ä½“åœ°å€éœ€è¦æ‰“ç”µè¯é—®", phone:"18561787096", mch:"105000159452778", subwx:"å¾®ä¿¡819178281", subali:"æ”¯ä»˜å®2088080203838459"},
  {name:"å•†æˆ·_æ±Ÿç¦æ˜¥", addr:"é‡‘æ²™æ»©è·¯966å·é‡‘æ²™æ»©å‡¤å‡°ä¹‹å£°å¤§å‰§é™¢å¤œå¸‚", phone:"18769770196", mch:"105000479953407", subwx:"å¾®ä¿¡819878153", subali:"æ”¯ä»˜å®2088080272614545"},
  {name:"å•†æˆ·_ç‹æµ·æ´‹", addr:"å¤ªè¡Œå±±ä¸€æ”¯è·¯47å·ç½‘ç‚¹", phone:"17669866985", mch:"105000479953406", subwx:"å¾®ä¿¡819877471", subali:"æ”¯ä»˜å®2088080270735235"},
  {name:"é»„å²›åŒºæˆ‘çˆ±åƒä¾¿åˆ©åº—", addr:"æ±Ÿå±±å—è·¯11å·6å·é²å•†è“å²¸å›½é™…1å·æ¥¼å•†2å·", phone:"15563919457", mch:"105000654623847", subwx:"å¾®ä¿¡819878952", subali:"æ”¯ä»˜å®2088080270156148"},
  {name:"å•†æˆ·_ç‹è‰", addr:"å´æ±Ÿè·¯298å·", phone:"19105323030", mch:"105000479953430", subwx:"å¾®ä¿¡820203049", subali:"æ”¯ä»˜å®2088080291826341"},
  {name:"å•†æˆ·_é‚¹æ´ªæ°¸", addr:"ç æ±Ÿè·¯106å·å‡¤å‡°åŸ31-14ç½‘ç‚¹", phone:"19862238880", mch:"105000479953429", subwx:"å¾®ä¿¡820202994", subali:"æ”¯ä»˜å®2088080294048669"},
  {name:"å•†æˆ·_èµµè‰³", addr:"é•¿ç™½å±±è·¯822-12å·å•†é“º", phone:"13326308370", mch:"105000479953426", subwx:"å¾®ä¿¡820203270", subali:"æ”¯ä»˜å®2088080291274230"},
  {name:"å•†æˆ·_æè‰³æ´", addr:"è–›å®¶å²›è¡—é“å˜‰é™µæ±Ÿä¸œè·¯487å·å†…2å·ç½‘ç‚¹1å±‚101å·", phone:"15305424999", mch:"105000479953425", subwx:"å¾®ä¿¡820202697", subali:"æ”¯ä»˜å®2088080294131950"},
  {name:"å•†æˆ·_å¼ æ–°æ™“", addr:"å›¢ç»“è·¯äºæ±¾æ²³è·¯äº¤å‰å£", phone:"13869811345", mch:"105000479953449", subwx:"å¾®ä¿¡820750114", subali:"æ”¯ä»˜å®2088080331002823"},
  {name:"å•†æˆ·_è–›çº¢", addr:"æ´åº­å±±è·¯", phone:"13165161969", mch:"105000479953453", subwx:"å¾®ä¿¡820887845", subali:"æ”¯ä»˜å®2088080336265755"},
  {name:"å•†æˆ·_é²é‡‘æµ·", addr:"é’±å¡˜æ±Ÿè·¯268å·-6ç½‘ç‚¹", phone:"18660233639", mch:"105000479953464", subwx:"å¾®ä¿¡821085249", subali:"æ”¯ä»˜å®2088080350756363"}
];

// â€”â€” ä»Šæ—¥å¾…æ¿€æ´»å›¾å±‚ï¼ˆ13 æˆ·ï¼‰ â€”â€”
const RAW_TODAY = [
  {name:"å•†æˆ·_é—«æ¶µ", addr:"å…´éš†è·¯10å·", phone:"13325009494", mch:"105000479953210", subwx:"å¾®ä¿¡814221549", subali:"æ”¯ä»˜å®2088970723467122"},
  {name:"å•†æˆ·_å¼ äºšä¸½", addr:"å¨æµ·è·¯262å·ç¾å®å•†åŠ¡æ¥¼", phone:"15315996321", mch:"105000479953217", subwx:"å¾®ä¿¡814443314", subali:"æ”¯ä»˜å®2088970740907515"},
  {name:"å¸‚åŒ—åŒºæ­¦å“¥ç™¾è´§åº—", addr:"å°ä¸œä¸ƒè·¯ä¸é¡ºå…´è·¯äº¤å‰å£", phone:"18661980333", mch:"105006753316545", subwx:"å¾®ä¿¡818637066", subali:"æ”¯ä»˜å®2088080166669020"},
  {name:"é’å²›å¸‚ææ²§åŒºå±¿å²¸çº¿äº’è”ç½‘ç§‘æŠ€å·¥ä½œå®¤", addr:"ææ²§åŒºå®¾å·è·¯51-38å·", phone:"18105324252", mch:"105000373724202", subwx:"å¾®ä¿¡818634197", subali:"æ”¯ä»˜å®2088080166243842"},
  {name:"å•†æˆ·_ç”˜å»¶çœŸ", addr:"å¤åº„è·¯1å·ä¹å®¢åŸB1-D-08-15å·", phone:"17191090195", mch:"105000479953301", subwx:"å¾®ä¿¡817346325", subali:"æ”¯ä»˜å®2088080067181782"},
  {name:"å•†æˆ·_ç‰›åº†æ–‹", addr:"å¤åº„è·¯1å·ä¼Ÿä¸œä¹å®¢åŸè´Ÿä¸€æ‚¦è¡—A-29-1", phone:"13615423696", mch:"105000479953345", subwx:"å¾®ä¿¡818391433", subali:"æ”¯ä»˜å®2088080148535343"},
  {name:"å•†æˆ·_ç‹çŸ¥æ–‡", addr:"äººæ°‘è·¯130å·", phone:"18661920863", mch:"105000479953282", subwx:"å¾®ä¿¡817130641", subali:"æ”¯ä»˜å®2088080055589248"},
  {name:"å•†æˆ·_åˆ˜ç„•æ–Œ", addr:"ä¸‡å¹´æ³‰è·¯116å·", phone:"18953220501", mch:"105000479953281", subwx:"å¾®ä¿¡817130729", subali:"æ”¯ä»˜å®105000479953281"},
  {name:"å•†æˆ·_è–›å©§", addr:"è¾½é˜³è¥¿è·¯2å·", phone:"13969729607", mch:"105000479953273", subwx:"å¾®ä¿¡817038027", subali:"æ”¯ä»˜å®2088080048186119"},
  {name:"ææ²§åŒºæ‚¦å¨æºé¤é¥®åº—(ä¸ªä½“å·¥å•†æˆ·)", addr:"é»‘é¾™æ±Ÿä¸­è·¯649å·E01", phone:"15712706395", mch:"105012158129339", subwx:"å¾®ä¿¡817049675", subali:"æ”¯ä»˜å®2088080047581948"},
  {name:"å¸‚åŒ—åŒºçˆ±è¯ºæ³½æ˜Ÿæ•°ç ç§‘æŠ€æœåŠ¡ä¸­å¿ƒ(ä¸ªä½“å·¥å•†æˆ·)", addr:"è¾½å®è·¯147å·ç™¾è„‘æ±‡0H18", phone:"18605329800", mch:"105000150453987", subwx:"å¾®ä¿¡817130325", subali:"æ”¯ä»˜å®2088080052675650"},
  {name:"å•†æˆ·_èŒƒå©·å©·", addr:"å»¶å‰è·¯77å·1-2ç½‘ç‚¹", phone:"13061398069", mch:"105000479953227", subwx:"å¾®ä¿¡814557557", subali:"æ”¯ä»˜å®2088970750039545"},
  {name:"å•†æˆ·_ç”°æƒ ", addr:"å¤§æ¸¯ä¸€è·¯59å·", phone:"13505428583", mch:"105000479953258", subwx:"å¾®ä¿¡816708033", subali:"æ”¯ä»˜å®2088080024949615"},
  {name:"å•†æˆ·_ç‹çç", addr:"å…´å¾·è·¯96å·-2", phone:"15854239667", mch:"105000479953255", subwx:"å¾®ä¿¡816708110", subali:"æ”¯ä»˜å®2088080024554435"}
];

const map=new AMap.Map('map',{zoom:11,center:CENTER});
let geocoder = new AMap.Geocoder({city: CITY});
const log=(...a)=>{const el=document.getElementById('log'); el.textContent += a.join(' ')+'\n'; el.scrollTop=el.scrollHeight;};
const setP=(i,t)=>document.getElementById('p').style.width=(t?Math.round(i*100/t):0)+'%';
const save=(name,txt,type='text/plain;charset=utf-8')=>{const b=new Blob([txt],{type}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=name; a.click(); URL.revokeObjectURL(a.href);};

async function encode(list,label){
  const out=[]; let i=0; setP(0,list.length);
  for(const r of list){
    i++; const addr=(r.addr||'').trim();
    if(!addr){ out.push({...r,lng:null,lat:null}); setP(i,list.length); continue; }
    await new Promise(res=>{
      geocoder.getLocation(CITY+addr,(s,ret)=>{
        if(s==='complete'&&ret.geocodes&&ret.geocodes[0]){
          const L=ret.geocodes[0].location; out.push({...r,lng:L.lng,lat:L.lat}); log(`[${label}] ${i}/${list.length} OKï¼š${r.name}`);
        }else{
          out.push({...r,lng:null,lat:null}); log(`[${label}] ${i}/${list.length} æ— ç»“æœï¼š${r.name} ${addr}`);
        }
        res();
      });
    });
    await new Promise(r=>setTimeout(r,120)); setP(i,list.length);
  }
  return out;
}

function buildStatic(allRows,todayRows){
  const html=`<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å•†æˆ·åœ°å›¾ Â· é™æ€åŒå›¾å±‚ï¼ˆå…¨éƒ¨/ä»Šæ—¥å¾…æ¿€æ´»ï¼‰</title>
<style>html,body,#map{height:100%;margin:0}.ui{position:absolute;top:10px;left:10px;z-index:9;background:#fff;border-radius:12px;padding:12px 14px;box-shadow:0 8px 24px rgba(0,0,0,.15);font:14px/1.6 -apple-system,'PingFang SC','Microsoft YaHei',sans-serif;max-width:760px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px}.btn{padding:6px 10px;border:1px solid #e5e5e5;border-radius:8px;background:#fff;cursor:pointer}
.ip{height:32px;border:1px solid #e5e5e5;border-radius:8px;padding:0 10px}.small{font-size:12px;color:#666}.list{max-height:220px;overflow:auto;border:1px solid #eee;border-radius:8px;padding:6px;margin-top:6px}
.item{padding:4px 0;border-bottom:1px dashed #eee}.item:last-child{border-bottom:none}.tag{display:inline-block;padding:2px 6px;border-radius:999px;background:#1677ff;color:#fff;font-size:12px;margin-left:6px}.today{background:#ff6d00}</style>
<script src="https://webapi.amap.com/maps?v=2.0&key=7d26448f257946798a105c1bc02d653b"></scr`+`ipt></head><body>
<div id="map"></div><div class="ui">
  <div><b>å•†æˆ·åœ°å›¾ Â· é™æ€åŒå›¾å±‚</b> <span class="tag">å…¨éƒ¨ ${allRows.length}</span> <span class="tag today">ä»Šæ—¥å¾…æ¿€æ´» ${todayRows.length}</span></div>
  <div class="row"><label><input type="checkbox" id="chkAll" checked/> æ˜¾ç¤ºå…¨éƒ¨</label><label><input type="checkbox" id="chkToday" checked/> æ˜¾ç¤ºä»Šæ—¥å¾…æ¿€æ´»</label>
  <input class="ip" id="kw" placeholder="æœç´¢åç§°/åœ°å€/ç”µè¯/å•†æˆ·å·" style="flex:1 1 260px"/><button class="btn" id="btnSearch">æœç´¢</button><button class="btn" id="btnShowAll">æ˜¾ç¤ºå…¨éƒ¨</button></div>
  <div class="row"><button class="btn" id="btnLocate">ğŸ“ å®šä½</button><input class="ip" id="lng" placeholder="ç»åº¦" style="width:120px"/><input class="ip" id="lat" placeholder="çº¬åº¦" style="width:120px"/><button class="btn" id="btnUse">ç”¨åæ ‡</button><button class="btn" id="btnNearest">ğŸ” æœ€è¿‘10ä¸ª</button><button class="btn" id="btnRoute">ğŸ§­ é¡ºè·¯æ‹œè®¿</button><button class="btn" id="btnClear">æ¸…è·¯çº¿</button></div>
  <div class="row"><button class="btn" id="btnCSV">â¬‡ï¸ CSV</button><button class="btn" id="btnKML">â¬‡ï¸ KML</button></div>
  <div id="stat" class="small">â€”</div><div id="list" class="list"></div>
</div>
<script>
const ALL=${JSON.stringify(allRows)}; const TODAY=${JSON.stringify(todayRows)}; const CENTER=[120.3552,36.0826];
const map=new AMap.Map('map',{zoom:11,center:CENTER}), info=new AMap.InfoWindow({offset:new AMap.Pixel(0,-10)}); let mkAll=[],mkToday=[],cur=null,line=null;
function card(r){const nav='https://uri.amap.com/navigation?to='+r.lng+','+r.lat+','+encodeURIComponent(r.name||'ç›®æ ‡')+'&mode=car';return '<div style="font-size:14px;line-height:1.6;"><b>'+(r.name||'æœªå')+'</b><br/>åœ°å€ï¼š'+(r.addr||'')+'<br/>ç”µè¯ï¼š'+(r.phone||'â€”')+'<br/>å•†æˆ·å·ï¼š'+(r.mch||'â€”')+'<br/>'+(r.subwx||'')+'ï¼›'+(r.subali||'')+'<br/><a href="'+nav+'" target="_blank" style="color:#1677ff">ğŸš— é«˜å¾·å¯¼èˆª</a></div>';}
function add(rows,red){const arr=[];rows.filter(r=>r.lng&&r.lat).forEach(r=>{const m=new AMap.Marker({position:[r.lng,r.lat],title:r.name||'',icon:red?'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png':'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png'});m.on('click',()=>info.setContent(card(r))||info.open(map,m.getPosition()));map.add(m);arr.push(m);});return arr;}
function fit(){const it=[...mkAll,...mkToday]; if(it.length) map.setFitView(it,true,[80,80,80,360],16);}
function vis(ms,v){ms.forEach(m=>m[v?'show':'hide']());}
function shown(){const A=document.getElementById('chkAll').checked,T=document.getElementById('chkToday').checked;const a=A?ALL.filter(r=>r.lng&&r.lat):[];const b=T?TODAY.filter(r=>r.lng&&r.lat):[];const seen=new Set(),out=[];[...a,...b].forEach(r=>{const k=r.lng+','+r.lat+'|'+(r.name||'');if(!seen.has(k)){seen.add(k);out.push(r);}});return out;}
function H(x1,y1,x2,y2){const R=6371000,t=Math.PI/180,dY=(y2-y1)*t,dX=(x2-x1)*t;const a=Math.sin(dY/2)**2+Math.cos(y1*t)*Math.cos(y2*t)*Math.sin(dX/2)**2;return 2*R*Math.asin(Math.sqrt(a));}
function list(rows,title){document.getElementById('stat').innerHTML=title+'ï¼š<b>'+rows.length+'</b> ä¸ª';const panel=document.getElementById('list');panel.innerHTML='';rows.forEach((r,i)=>{const nav=r.lng&&r.lat?'https://uri.amap.com/navigation?to='+r.lng+','+r.lat+','+encodeURIComponent(r.name||'ç›®æ ‡')+'&mode=car':'';const d=document.createElement('div');d.className='item';d.innerHTML='<b>'+(i+1)+'. '+(r.name||'æœªå')+'</b>'+(r._dist!=null?' <span class="small">Â· '+(r._dist/1000).toFixed(2)+'km</span>':'')+'<br/>åœ°å€ï¼š'+(r.addr||'')+(r.phone?(' Â· ğŸ“'+r.phone):'')+(nav?('<br/><a href="'+nav+'" target="_blank">ğŸš— å¯¼èˆª</a>'):'');panel.appendChild(d);});}
function route(order,start){if(line){map.remove(line);line=null;}const path=[[start.lng,start.lat],...order.map(p=>[p.lng,p.lat])];line=new AMap.Polyline({path,strokeWeight:6,strokeColor:'#1677ff',strokeOpacity:.85});map.add(line);map.setFitView([line,...mkAll,...mkToday],true,[60,60,60,360],16);}
mkAll=add(ALL,false); mkToday=add(TODAY,true); fit();
document.getElementById('chkAll').onchange=()=>vis(mkAll,document.getElementById('chkAll').checked);
document.getElementById('chkToday').onchange=()=>vis(mkToday,document.getElementById('chkToday').checked);
document.getElementById('btnShowAll')?.addEventListener('click',()=>{vis(mkAll,true);vis(mkToday,true);document.getElementById('chkAll').checked=true;document.getElementById('chkToday').checked=true;fit();list(shown(),'å½“å‰æ˜¾ç¤º');});
document.getElementById('btnSearch')?.addEventListener('click',()=>{const kw=(document.getElementById('kw').value||'').trim(); if(!kw){list(shown(),'å½“å‰æ˜¾ç¤º');return;} const rows=shown().filter(r=>(r.name||'').includes(kw)||(r.addr||'').includes(kw)||(r.phone||'').includes(kw)||(r.mch||'').includes(kw)); list(rows,'æœç´¢â€œ'+kw+'â€');});
document.getElementById('btnLocate')?.addEventListener('click',()=>{if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>{cur={lng:p.coords.longitude,lat:p.coords.latitude};new AMap.Marker({position:[cur.lng,cur.lat],map,title:'æˆ‘çš„ä½ç½®'});map.setZoomAndCenter(13,[cur.lng,cur.lat]);});}});
document.getElementById('btnUse')?.addEventListener('click',()=>{const lng=parseFloat(document.getElementById('lng').value),lat=parseFloat(document.getElementById('lat').value);if(isFinite(lng)&&isFinite(lat)){cur={lng,lat};new AMap.Marker({position:[lng,lat],map,title:'æˆ‘çš„ä½ç½®'});map.setZoomAndCenter(13,[lng,lat]);}});
document.getElementById('btnNearest')?.addEventListener('click',()=>{if(!cur){alert('è¯·å…ˆå®šä½æˆ–è¾“å…¥åæ ‡');return;}const rows=shown().map(r=>({...r,_dist:H(cur.lng,cur.lat,r.lng,r.lat)})).sort((a,b)=>a._dist-b._dist).slice(0,10);list(rows,'æœ€è¿‘10ä¸ª');});
document.getElementById('btnRoute')?.addEventListener('click',()=>{if(!cur){alert('è¯·å…ˆå®šä½æˆ–è¾“å…¥åæ ‡');return;}let left=shown().slice(),order=[],c={...cur};while(left.length){left.forEach(p=>p._d=H(c.lng,c.lat,p.lng,p.lat));left.sort((a,b)=>a._d-b._d);const nxt=left.shift();order.push(nxt);c={lng:nxt.lng,lat:nxt.lat};}list(order,'é¡ºè·¯æ‹œè®¿');route(order,cur);});
document.getElementById('btnClear')?.addEventListener('click',()=>{if(line){map.remove(line);line=null;}list(shown(),'å½“å‰æ˜¾ç¤º');});
document.getElementById('btnCSV')?.addEventListener('click',()=>{const rows=shown();const head='åç§°,åœ°å€,ç”µè¯,å•†æˆ·å·,å¾®ä¿¡äºŒçº§,æ”¯ä»˜å®äºŒçº§,ç»åº¦,çº¬åº¦\\n';const body=rows.map(r=>[r.name||'',r.addr||'',r.phone||'',r.mch||'',r.subwx||'',r.subali||'',r.lng||'',r.lat||''].map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\\n');const b=new Blob([head+body],{type:'text/csv;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='å•†æˆ·_å½“å‰ç­›é€‰.csv';a.click();URL.revokeObjectURL(a.href);});
document.getElementById('btnKML')?.addEventListener('click',()=>{const rows=shown().filter(r=>r.lng&&r.lat);const ps=rows.map(r=>'<Placemark><name>'+(r.name||'æ ‡æ³¨')+'</name><description><![CDATA[åœ°å€ï¼š'+(r.addr||'')+'<br/>ç”µè¯ï¼š'+(r.phone||'â€”')+'<br/>å•†æˆ·å·ï¼š'+(r.mch||'â€”')+'<br/>'+(r.subwx||'')+'ï¼›'+(r.subali||'')+']]></description><Point><coordinates>'+r.lng+','+r.lat+',0</coordinates></Point></Placemark>').join('\\n');const k='<?xml version="1.0"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>å•†æˆ·_å½“å‰ç­›é€‰</name>'+ps+'</Document></kml>';const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([k],{type:'application/vnd.google-earth.kml+xml'}));a.download='å•†æˆ·_å½“å‰ç­›é€‰.kml';a.click();URL.revokeObjectURL(a.href);});
<\/script></body></html>`;
  return html;
}

async function run(){
  document.getElementById('msg').textContent='å¼€å§‹ç¼–ç ï¼ˆå…¨éƒ¨å•†æˆ·ï¼‰â€¦';
  const A = await encode(RAW_ALL,'å…¨éƒ¨');
  document.getElementById('msg').textContent='å¼€å§‹ç¼–ç ï¼ˆä»Šæ—¥å¾…æ¿€æ´»ï¼‰â€¦';
  const T = await encode(RAW_TODAY,'ä»Šæ—¥');

  document.getElementById('dump').onclick=()=>save('å•†æˆ·_åŒå›¾å±‚åæ ‡.json',JSON.stringify({all:A,today:T},null,2),'application/json');

  const final = buildStatic(A,T);
  save('å•†æˆ·åœ°å›¾_é™æ€åŒå›¾å±‚_å¯åˆ‡æ¢.html', final, 'text/html;charset=utf-8');
  document.getElementById('msg').textContent='å®Œæˆï¼å·²è‡ªåŠ¨ä¸‹è½½â€œå•†æˆ·åœ°å›¾_é™æ€åŒå›¾å±‚_å¯åˆ‡æ¢.htmlâ€ã€‚';
}

document.getElementById('run').onclick=run;
run(); // è‡ªåŠ¨è·‘ä¸€é
</script>
</body>
</html>
